<!DOCTYPE html>
<html lang="en">
<head>
  <title>CRIM Heat Map Visualization</title>

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" >
   <!-- jQuery library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
   <!-- Latest compiled JavaScript -->
   <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.bundle.min.js"></script>
   <!--script data-main="script.js" src="require.js"></script-->
   <script src="script.js"></script>
   <script src="timelines-chart.min.js"></script>
   <!--script src="//unpkg.com/timelines-chart"></script-->
   <!-- custom css -->
   <link href="style.css" rel="stylesheet">

</head>

<body>

 <main role="main" class="container">
   <div class="page-header">
<br>
  <h1>Heat Map Visualization</h1>
  <br>
   </div>

<div class="row">
	<div class="col-md-1"></div>
	<div class="col-md-10" >
    <form class="form-inline" id="search_form">
      <span class="input-group-append" id="search_form">
        <div class="form-row">
          <div class="col-sm-4">
        <div class="input-group mb-3" id="select-form">
          <div class="input-group-prepend">
            <label class="input-group-text" for="inputGroupSelect01">Search by:</label>
          </div>
          <select id="selector" class="custom-select" onchange="test();" id="inputGroupSelect01">
            <option value="0" selected >Choose...</option>
            <option value="1" >Score Title</option>
            <option value="2" >User ID</option>
          </select>
        </div>
      </div>

        <div class="col-sm-8">
          <div class="input-group mb-3" id="search_box">
	    <!--label for="score_title">Search for score title:</label-->
            <input type="text" class="form-control" id="score_title">
        	     <button class="btn btn-outline-secondary" type="button"  onclick="search()">Search</button>
            </span>
	        </div>
        </div>
            </div>
          <br>
        </form>
  </div>
  <div class="col-md-1">
    <button type="button" class="btn btn-info"  id='help' data-placement="bottom" data-toggle="popover" title="Welcome!" data-content="Select a type of search by clicking 'Choose...' and selecting from the options">?</button>
  <!--  <button type="button" class="btn btn-info" data-toggle="tooltip" id="help" data-placement="bottom" title="Tooltip on left"> ? </button>-->
  </div>
</div>
<div class="row">
  <div class="col-md-1"></div>
  <div class="col-md-10" id="myPlot"></div>
  <div class="col-md-1"></div>
</div>


<div class="container" id="searchResults" style='display:none'>
  <h2>Results</h2>
  <p>Click on the button to toggle between showing and hiding content displayed in the visualization above.</p>
  <button type="button" class="btn btn-info" data-toggle="collapse" data-target="#Description" aria-expanded="false" aria-controls="Description">Collapsible Results</button>
  <div class="collapse" id="Description">
    <div id='myTable'> </div>

    </div>
</div>

</main>
<footer class="footer">
      <div class="container">
        <span class="text-muted">Supported by <a href="https://www.haverford.edu/library/digital-scholarship"> Haverford Digital Scholarship</a> for the <a href="https://sites.google.com/a/haverford.edu/crim-project/"> CRIM project</a></span>
      </div>
    </footer>

 <script type="text/javascript">

 function test(){
    /////////////////////////////////////////////////////
   /// here is where we will edit the help tooltip ! ///
  /////////////////////////////////////////////////////
   var e = document.getElementById("selector");
   var value = e.options[e.selectedIndex].value;
   var text = e.options[e.selectedIndex].text;
   console.log(value,text,"has been selected");
   var helpText= 'Some Helpful info about this search will go here!';
   if (value === "1") {  // if value === "1" then the text will be about the Song view
     helpText = "This is the Search for a particular song - try 'Benedicta es'";
     text += ' Search';
   }
   else if (value === "2") { // if value === "2" then the text will be about the User view
     helpText = 'This is the Search for a particular user - try searching a number ...';
     text += ' Search';
   }
   else { // if value === "0" then the text will be even more thorough bc they are still on "choose ..."
     helpText = "Select a type of search by clicking 'Choose...' and selecting from the options";
     text = 'Welcome!';
   }


   document.getElementById('help').setAttribute('data-original-title',text);
   document.getElementById('help').setAttribute('data-content',helpText);

}


 $('#help').popover({
   trigger: 'focus'
   // trigger focus on the #selector when still on "choose..."
 })


// $(function () {
//   $('[data-toggle="tooltip"]').tooltip()
// })

 var jsonfile = {};
  $("#score_title").ready(function() {
    $.getJSON('ema.json').done(function (data) {
      jsonfile = data;
      //console.log("jsonfile1, ", jsonfile);
    //  runcodeafter();
    });
  });
/* //jquery is done asynchronously so  jsonfile3 is called before the json actually loads!
  console.log("jsonfile2, ", jsonfile);
}
console.log("jsonfile3, ", jsonfile);

"rt-q": Quotation
"rt-tm": Transformation (mechanical)
"rt-tnm": Transformation (non mechanical)
"rt-nm": New Material
"rt-om": Omission
*/

$.makeTable = function (mydata) {
    var type_dict = {"rt-q": "Quotation", "rt-tm": "Transformation (mechanical)", "rt-tnm": "Transformation (non mechanical)","rt-nm": "New Material","rt-om": "Omission"}
    var table = $("<table class='table table-hover table-bordered'>");
    var tblHeader = "<thead><tr> <th scope='col'> # </th>";
    for (var k in mydata[0]) tblHeader += "<th scope='col'>" + k + "</th>";
    tblHeader += "</tr></thead><tbody>";
    $(tblHeader).appendTo(table);
    $.each(mydata, function (index, value) {
        var TableRow = "<tr> <td scope='row'><b>" + index + "</b></td>";
        $.each(value, function (key, val) {
            //doing a quick dict replace to un-abreviate of type abreviation
            if (key === "typee"){
              TableRow += "<td>" + type_dict[val] + "</td>";
            }
            else {
              TableRow += "<td>" + val + "</td>";
            }
        });
        TableRow += "</tr>";
        $(table).append(TableRow);
    });
    var end = "</tbody></table>";
    return ($(table));
};


function buildResults(results){
  var title = document.getElementById("score_title").value;
  var fromsongs = results;
  console.log("from songs, ", fromsongs);
  console.log("results, ", results);

  var mydata = eval(results);
  var table = $.makeTable(mydata);
  $(table).appendTo("#myTable");

}

/*
>>> JSON.stringify(jsonfile["Benedicta es"][1])
>>> "{"Song_From":": Benedicta es,cÃ¦lorum Regina","measures":"1","typee":"rt-tnm"}"
>>> Object.keys(jsonfile["Benedicta es"][1])
>>> (3) ["Song_From", "measures", "typee"]
*/


function clearResults(){
  // removes the previous results -- if they exist
  // and shows the Collapsible results div
  document.getElementById('myPlot').innerHTML = '';
  document.getElementById('myTable').innerHTML = '';
  document.getElementById('searchResults').style.display = 'block';
}

function search(){
	  var title = document.getElementById("score_title").value ;
    if (title !=''){
      clearResults();
    }

    //console.log(title);
	 // var fromsongs = jsonfile[title];
    /// now that we have searched for something we can build the chart! ///
//  $.holdReady(false);
//$( document ).ready(function() {
    var jsonfile;
    $.getJSON('ema_2.json').done(function (data) {
      jsonfile = data;
      var title = document.getElementById("score_title").value ;

    buildResults(jsonfile[title]);
    TimelinesChart()
      .data(genData(jsonfile, title,  "Song_From", "record_id"))
      .zQualitative(true)
      .timeFormat('%Q')
      .xTickFormat(n => +n)
      (document.getElementById('myPlot'));
        });
}

</script>
</body>

</html>
